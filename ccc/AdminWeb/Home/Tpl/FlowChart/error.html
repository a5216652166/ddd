<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Access-Control-Allow-Origin" content="*">
<meta name="Keywords" content="DNSPro">
<meta name="Description" content="DNSPro DNS 域名解析">
<title>EflyDNS管理后台</title>
<link type="text/css" rel="stylesheet" href="__ROOT__/Public/css/style.css">
<link rel="shortcut icon" href="__ROOT__/eflydns.ico" />
<script type="text/javascript" src="__ROOT__/Public/js/jquery-1.8.1.min.js"></script>
<script type="text/javascript" src="__ROOT__/Public/js/jquery.SuperSlide.2.1.js"></script>
<script type="text/javascript" src="__ROOT__/Public/js/highcharts/highcharts.js"></script>
<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
<!--[if lt IE 9]>
    <script src="./js/html5.js"></script>
<![endif]-->
</head>
<body>
<!-- 头部 S -->
<include file="Public:header" />
<!-- 头部 e -->
<div class="clear"></div>
<div class="content"><!-- 内容 -->
	<!-- left菜单 S -->
	<div style="float:left;width:172px;">
        <div id="sideMenu" class="side">
            <div class="hd">
                <div style="float:left"><span style="background:url(__ROOT__/Public/img/lljk.png) no-repeat;"></span><h3>统计报表</h3></div>
            </div>
            <div class="bd">
                <ul>
                    <li><a href="__APP__/FlowChart/index">总流量</a></li>
                    <li><a class="active" href="__APP__/FlowChart/error">无效请求</a></li>                    
                    <li><a href="__APP__/FlowChart/proportion">流量概况</a></li>
                </ul>
            </div>
        </div>
        <!--div id="sideMenu1" class="side">
            <div class="hd">
                <h3>历史统计</h3>
            </div>
            <div class="bd">
                <ul>
                    <li><a href="__APP__/FlowChart/history">总流量</a></li>
                    <li><a href="__APP__/FlowChart/error_history">无效请求</a></li>
                    <li><a href="__APP__/FlowChart/history_proportion">流量概况</a></li>
                </ul>
            </div>
        </div-->
    </div>
	<script type="text/javascript">
		jQuery("#sideMenu").slide({ titCell:".hd", targetCell:".bd",  trigger:"click" });
		jQuery("#sideMenu1").slide({ titCell:".hd", targetCell:".bd",  trigger:"click" });
    </script>
	<!-- left菜单 E -->
	
	<!-- mainContent s -->
	<div class="mainContent">
    		
		<!-- Tab切换 S -->
		<div class="slideTxtBox">
			<div class="hd">
				<h2 style="float:left;">实时数据</h2>
				<a href="__APP__/FlowChart/error_history">历史数据</a>
			</div>
            <div style="margin:20px 0px 0px 40px;">
            	<label>选择设备：</label>
                <select id="ip_list" onchange="selectBy();" style="margin-bottom:0px;width:120px;">
                	<option value="">全部</option>
                    <volist name="ipList" id="item">
	                	<option value="{$item}">{$item}</option>
                    </volist>
                </select>
                <label>选择视图：</label>
                <select id="view_list" onchange="selectBy();" style="margin-bottom:0px;width:120px;">
	                <option value="">全部</option>
                    <volist name="viewList" id="item">
	                	<option value="{$item.id}">{$item.name}</option>
                    </volist>
                </select>                
				<a style="margin-left:20px;color:#1c8fdf;text-decoration:underline" href="__APP__/FlowChart/error_history">查看历史数据</a>
			</div>
			<div class="bd">
				<div id="container" style="min-width:700px;height:400px"></div>
			</div>
		</div>
		<script type="text/javascript">jQuery(".slideTxtBox").slide();</script>
		<!-- Tab切换 E -->
	</div>
</div>
<include file="Public:footer" />
<script type="text/javascript">	
	//这种导航效果相当于Tab切换，用titCell和mainCell 处理
	/*jQuery(".navBar").slide({ 
		titCell:".nav .m", // 鼠标触发对象
		mainCell:".subNav", // 切换对象包裹层
		delayTime:0, // 效果时间
		triggerTime:0, //鼠标延迟触发时间
		returnDefault:true  //返回默认状态
	});*/
</script> 
</body>
</html>
<script type="text/javascript" src="__ROOT__/Public/js/layer/layer.js"></script>
<script type="text/javascript">
var chart, last_query = "",result,max_num = 0, max_time = "", load_layer;
$(function () {
	load_layer = layer.load('正在加载数据...',2);
	setInterval(function (){layer.close(load_layer);},2000);
	var IP = '{$ip}',VIEW = '{$view}';
	$("#ip_list").val(IP);	
	$("#view_list").val(VIEW);	
	Highcharts.setOptions({                                                     
		global: {                                                               
			useUTC: false                                                       
		}
	});
	
	$.ajax({	
		url: "__APP__/FlowChart/error",
		type:'post',
		data:{'ip':IP,'view':VIEW},
		async:false,
		success: function (data) {
			result = data.data;
			if(data.info=='success'){
				chart = new Highcharts.Chart({
					chart: {
						renderTo: 'container',
						zoomType: 'x',
						animation: Highcharts.svg, // don't animate in old IE
						marginRight: 10,
						events: {
							load: function() {
								setInterval(function() {
									var url = "http://api.efly.cc/eflydns/dns_chart_error.php?time=" + last_query ;
									switch(true){
										case IP!="" && VIEW!="":
											url += "&ip=" + IP + "&view=" + VIEW;
										break;
										case IP!="" && VIEW=="":
											url += "&ip=" + IP ;
										break;
										case IP=="" && VIEW!="":
											url += "&view=" + VIEW;
										break;
									}
									url += url + "&callback=?";
									$.ajax({	
										url: url,
										type: "GET",
										dataType: 'jsonp',
										success: function (result) {
											if(result.descmap.length >= 1) {
												for (var i = 0; i < result.descmap.length; i++) {
													var x = Date.parse(result.descmap[i]["time"].replace(/-/g,"/")),
													y = parseInt(result.descmap[i]["err"]);
													chart.series[0].addPoint([x, y], true, true);
												}
												last_query = result.descmap[result.descmap.length - 1]["time"];
											}else{
												//alert(data.error);
											}										
										},
										cache: false,
										error: function (result) {
											//alert(result.statusText);
										}
									});
								}, 4000);
							}
						}
					},
					title: {
						text: '最近60分钟内并发量'
					},
					xAxis: {
						type: 'datetime',
						tickPixelInterval: 120
					},
					yAxis: {
						title: {
							text: '并发量QPS'
						},
						min: 0,
						plotLines: [{
							value: 0,
							width: 1,
							color: '#808080'
						}]
					},
					tooltip: {
						formatter: function() {
							return '<b>'+ this.series.name +'</b><br/>'+
							Highcharts.dateFormat('%Y-%m-%d %H:%M:%S', this.x) +'<br/>'+
							Highcharts.numberFormat(this.y, 0);
						}
					},
					legend: {
						enabled: false
					},
					plotOptions: {
						area: {
							fillColor: {
								linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1},
								stops: [
									[0, '#FF0000'],//Highcharts.getOptions().colors[0]],
									[1, '#FFA488']//Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
								]
							},
							lineWidth: 1,
							marker: {
								enabled: false
							},
							shadow: false,
							states: {
								hover: {
									lineWidth: 1
								}
							},
							threshold: null
						}
					},
					exporting: {
						enabled: false
					},
					series: [{
						type: 'area',
						name: '无效请求',
						color:"red",
						data: (function() {
							var data = [], i;
							if(result.descmap.length > 0){
								for (i = 0; i < result.descmap.length; i++) {
									data.push({
										x: Date.parse(result.descmap[i]["time"].replace(/-/g,"/")),
										y: parseInt(result.descmap[i]["err"])
									});									
								}
								last_query = result.descmap[result.descmap.length-1]["time"];
							}
							return data;
						})()
					}]
				});
			}else{
				alert(data.data);
			}
		}
	});
});		
function selectBy(){
	var ip = $("#ip_list").val(),view = $("#view_list").val(),url = '__APP__/FlowChart/error';
	switch(true){
		case ip!="" && view!="":
			url += "?ip=" + ip + "&view=" + view;
		break;
		case ip!="" && view=="":
			url += "?ip=" + ip;
		break;
		case ip=="" && view!="":
			url += "?view=" + view;
		break;
	}
	window.location.href = url;
}		
</script>
